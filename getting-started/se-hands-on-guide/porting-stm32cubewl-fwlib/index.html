<!DOCTYPE html>

<html class="has-navbar-fixed-top">

<head>
  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-11557232-16"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-11557232-16');
  </script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="generator" content="Hugo 0.70.0" />
  <title>Porting STM32CubeWL Firmware Library | Generic Node</title><link rel="canonical" href="https://www.genericnode.com/docs/getting-started/se-hands-on-guide/porting-stm32cubewl-fwlib/" />
  <link rel="alternate icon" href="/docs/favicon.ico">
  <link rel="alternate icon" type="image/png" href="/docs/favicon.png">
  <link rel="icon" type="image/png" href="/docs/favicon.png">
  <link rel="stylesheet" href="https://www.genericnode.com/docs/css/theme.min.3f836fedc9c6a2b86da58d8c83e93a00336ad147490c56a3e1c424807e9787c1.css" integrity="sha256-P4Nv7cnGorhtpY2Mg&#43;k6ADNq0UdJDFaj4cQkgH6Xh8E=" crossorigin="anonymous">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta itemprop="name" content="Porting STM32CubeWL Firmware Library">
  <meta itemprop="description" content="">
  <meta itemprop="keywords" content="">
  <meta property="og:title" content="Porting STM32CubeWL Firmware Library">
  <meta property="og:description" content="">
  <meta property="og:url" content="https://www.genericnode.com/docs/getting-started/se-hands-on-guide/porting-stm32cubewl-fwlib/">
  <meta name="twitter:title" content="Porting STM32CubeWL Firmware Library" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:card" content="summary" />
</head>


<body>

<nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/docs/">
        <img class="logo" src="/docs/img/GN-logo.svg">
        <p class="navbar-item is-size-7"></p>
      </a>
      <span class="navbar-burger burger" data-target="topMenu">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </div>
    <div id="topMenu" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item" href="/docs/getting-started/">Getting Started</a>
        <a class="navbar-item" href="/docs/applications/">Applications</a>
        <a class="navbar-item" href="/docs/sensor-edition/">Sensor Edition</a>
        <a class="navbar-item" href="/docs/tracker-edition/">Tracker Edition</a>
      </div>
      <div class="navbar-end">
      </div>
    </div>
  </div>
</nav>


<main>
<section class="section">
  <div class="container">
    <div class="columns">
      
      <div class="column is-one-third">


<h2 class="title is-size-4">Sensor Edition Tutorials</h2>

<ul class="menu-list">
<a href="https://www.genericnode.com/docs/getting-started/se-hands-on-guide/" class="">Overview</a>
<li>
  <a href="https://www.genericnode.com/docs/getting-started/se-hands-on-guide/porting-stm32cubewl-fwlib/" class="is-active">Porting STM32CubeWL Firmware Library</a>
</li>
</ul>





      </div>
      
      <div class="column is-two-thirds">

<h1 class="title is-size-2">Porting STM32CubeWL Firmware Library


</h1>

<div class="content">


<p>This tutorial will help you port the <strong>STM32CubeWL firmware library</strong> to the <strong>Generic Node Sensor Edition</strong>.</p>
<p>The following figure shows the top view of NUCLEO-WL55JC1 (left) and Generic Node Sensor Edition (right).</p>
<figure>
    <img src="nucleo-wl55jc1-vs-generic-node.png"
         alt="NUCLEO-WL55JC1 vs Generic Node Sensor Edition"/> 
</figure>

<p>The STM32CubeWL firmware library contains templates, examples, applications, and demonstrations for supported boards including NUCLEO-WL55JC1. The applications written for NUCLEO-WL55JC1 (based on STM32WL55JC) can be modified to run on Generic Node Sensor Edition (based on STM32WL55CCU6) because both boards belong to the same device subfamily and have the same memory size. However, these boards have different pin counts: NUCLEO-WL55JC1 has 73 pins while Generic Node Sensor Edition has 48 pins.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p><strong>Software:</strong> Download and install the following software if your operating system does not already have one.</p>
<ul>
<li><a href="https://www.st.com/en/development-tools/stm32cubeide.html">STM32CubeIDE</a></li>
<li><a href="https://www.st.com/en/development-tools/stm32cubeprog.html">STM32CubeProgrammer</a></li>
<li><a href="https://osdn.net/projects/ttssh2/releases/">TeraTerm</a></li>
</ul>
</li>
<li>
<p><strong>Hardware:</strong> You will require the following hardware and accessories.</p>
<ul>
<li><a href="https://www.thethingsshop.com/products/generic-node-sensor-edition">Generic Node Sensor Edition</a></li>
<li><a href="https://www.st.com/en/development-tools/stlink-v3set.html">ST-LINK V3</a></li>
<li><a href="https://www.sparkfun.com/products/12794">Jumper wires (M/F)</a></li>
<li>Two AA batteries</li>
<li>micro USB cable</li>
</ul>
</li>
</ul>
<h2 id="downloading-stm32cubewl-firmware-package">Downloading STM32CubeWL firmware package</h2>
<p>The STM32CubeWL firmware package comes in a single ZIP file. First, download the v1.1.0 and extract it into the folder of your choice.</p>
<figure>
    <img src="stm32-cube-mcu-package-download.png"
         alt="Downloading STM32CubeWL firmware package"/> 
</figure>

<h2 id="connecting-to-st-link">Connecting to ST-LINK</h2>
<p>The easiest way to connect Generic Node Sensor Edition to the ST-LINK V3 is by using male/female jumper wires. The table below provides an overview of which pins to connect:</p>
<table>
<thead>
<tr>
<th>Pin function</th>
<th>ST-LINK V3</th>
<th>Generic Node Sensor Edition</th>
</tr>
</thead>
<tbody>
<tr>
<td>+3.3V</td>
<td>VCC</td>
<td>VCC</td>
</tr>
<tr>
<td>Ground</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>Clock</td>
<td>CLK</td>
<td>CLK</td>
</tr>
<tr>
<td>Data</td>
<td>DIO</td>
<td>SWD</td>
</tr>
<tr>
<td>Reset</td>
<td>NRST</td>
<td>NRST</td>
</tr>
</tbody>
</table>
<p>Insert batteries to the battery compartment. Then connect ST-LINK V3 to your computer using the micro USB cable. Once finished your hardware setup looks something like this:</p>
<figure>
    <img src="hardware-setup.png"
         alt="Hardware setup"/> 
</figure>

<h2 id="finding-deveui">Finding DevEUI</h2>
<p>The DevEUI of your Generic Node Sensor Edition is stored in the registry location <code>0x1fff7580</code>. The DevEUI that’s printed behind the enclosure is the Secure Element’s DevEUI and it is being used for the out-of-the-box demo app. In this case, you can also use that value as well.</p>
<ul>
<li>Start STM32CubeProgrammer.</li>
<li>Click the <strong>Connect</strong> button.</li>
<li>Enter the address, the size of the data, and the data width to be read, and then click on the <strong>Read</strong> button in the top-left corner.</li>
</ul>
<figure>
    <img src="deveui-registry.png"
         alt="read DevEUI from registry"/> 
</figure>

<p>Note that the bytes are in little-endian format. So you can write the DevEUI as <code>00 80 E1 15 05 01 XX XX</code> which is in big-endian format.</p>
<h2 id="adding-your-generic-node-sensor-edition-to-the-things-stack">Adding your Generic Node Sensor Edition to The Things Stack</h2>
<p>Follow the instructions on <a href="https://www.thethingsindustries.com/docs/devices/adding-devices/">Adding Devices</a> page to add your Generic Node Sensor Edition to <a href="https://www.thethingsindustries.com/docs/getting-started/ttn/addresses/">The Things Stack</a>.</p>
<ul>
<li><strong>AppEUI</strong> - fill with zeros for testing purposes.</li>
<li><strong>DevEUI</strong> - use the DevEUI you retrieve from the above section.</li>
<li><strong>AppKey</strong> - select the Generate button.</li>
</ul>
<h2 id="opening-the-demo-application">Opening the Demo Application</h2>
<p>Open the single-core project, <strong>LoRaWAN_End_Node</strong> which is a demo application that is found in the STM32CubeWL firmware library.</p>
<ul>
<li>
<p>In the <strong>System Explorer</strong> navigate to <code>STM32Cube_FW_WL_V1.1.0\Projects\NUCLEO-WL55JC\Applications\ LoRaWAN\LoRaWAN_End_Node\STM32CubeIDE</code>.</p>
</li>
<li>
<p>Double click on the <code>.project</code> file.</p>
</li>
</ul>
<figure>
    <img src="open-demo-project.png"
         alt="Open Demo Application"/> 
</figure>

<ul>
<li>This should launch the STM32CubeIDE.</li>
</ul>
<h2 id="building-the-project">Building the Project</h2>
<ul>
<li>In <strong>Project Explorer</strong>, choose the project node, <strong>LoRaWAN_End_Node</strong>.</li>
<li>On the menu bar, choose <strong>Project &gt; Build Project</strong>, or on the toolbar, select the <strong>hammer</strong> button.</li>
</ul>
<figure>
    <img src="build-project.png"
         alt="Build project"/> 
</figure>

<ul>
<li>The <strong>Console</strong> window displays the results of the build. The build succeeded.</li>
</ul>
<figure>
    <img src="console-output.png"
         alt="Console output"/> 
</figure>

<p>In <strong>Project Explorer</strong>, expand <strong>LoRaWAN_End_Node &gt;  includes &gt; STM32Cube_FW_WL_V1.1.0\Projects\NUCLEO-WL55JC\Applications\LoRaWAN\LoRaWAN_End_Node\LoRaWAN\App</strong>. Then double click on the <code>lora_app.h</code> file.</p>
<figure>
    <img src="lora-app-h.png"
         alt="lora_app.h"/> 
</figure>

<ul>
<li>Edit line 43 to match your LoRaWAN region.</li>
</ul>
<pre><code>/* LoraWAN application configuration (Mw is configured by lorawan_conf.h) */
#define ACTIVE_REGION                               LORAMAC_REGION_EU868
</code></pre><ul>
<li>In <strong>Project Explorer</strong> expand <strong>LoRaWAN_End_Node &gt; Drivers &gt; BSP &gt; STM32WLxx_Nucleo</strong>. Right-click on the <code>stm32wlxx_nucleo_radio.c</code> file and from the shortcut menu select <strong>Show In &gt; System Explorer</strong>.</li>
</ul>
<figure>
    <img src="show-in-system-explorer.png"
         alt="Show in system explorer"/> 
</figure>

<ul>
<li>In <strong>System Explorer</strong> select the following files:
<ul>
<li>stm32wlxx_nucleo.c</li>
<li>stm32wlxx_nucleo.h</li>
<li>stm32wlxx_nucleo_radio.c</li>
<li>stm32wlxx_nucleo_radio.h</li>
</ul>
</li>
</ul>
<figure>
    <img src="system-explorer.png"
         alt="System explorer"/> 
</figure>

<ul>
<li>Right-click on the selected files and select <strong>Properties</strong> from the menu. In the Properties window remove the <strong>Read-only</strong> attribute. When you are done select the <strong>Apply</strong> button and then select the <strong>OK</strong> button.</li>
</ul>
<figure>
    <img src="file-properties.png"
         alt="File properties"/> 
</figure>

<ul>
<li>
<p>Double click on <code>stm32wlxx_nucleo_radio.c</code> file and then in <strong>Outline</strong> view double click on <code>stm32wlxx_nucleo_radio.h</code> file.</p>
</li>
<li>
<p>In the <code>stm32wlxx_nucleo_radio.h</code> file, modify the RF switch GPIOs to match with the Generic Node Sensor Edition (line 84 - 97). Here is the pin mapping between NUCLEO-WL55JC and the Generic Node Sensor Edition.</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>RF SWITCH</th>
<th>NUCLEO-WL55JC1</th>
<th>Generic Node Sensor Edition</th>
</tr>
</thead>
<tbody>
<tr>
<td>RF_CTRL1</td>
<td>PC4</td>
<td>PA0</td>
</tr>
<tr>
<td>RF_CTRL2</td>
<td>PC5</td>
<td>PA1</td>
</tr>
<tr>
<td>RF_CTRL3</td>
<td>PC3</td>
<td>PB8</td>
</tr>
</tbody>
</table>
<pre><code>#define RF_SW_CTRL3_PIN                          GPIO_PIN_8
#define RF_SW_CTRL3_GPIO_PORT                    GPIOB
#define RF_SW_CTRL3_GPIO_CLK_ENABLE()            __HAL_RCC_GPIOB_CLK_ENABLE()
#define RF_SW_CTRL3_GPIO_CLK_DISABLE()           __HAL_RCC_GPIOB_CLK_DISABLE()


#define RF_SW_CTRL1_PIN                          GPIO_PIN_0
#define RF_SW_CTRL1_GPIO_PORT                    GPIOA
#define RF_SW_CTRL1_GPIO_CLK_ENABLE()            __HAL_RCC_GPIOA_CLK_ENABLE()
#define RF_SW_RX_GPIO_CLK_DISABLE()              __HAL_RCC_GPIOA_CLK_DISABLE()


#define RF_SW_CTRL2_PIN                          GPIO_PIN_1
#define RF_SW_CTRL2_GPIO_PORT                    GPIOA
#define RF_SW_CTRL2_GPIO_CLK_ENABLE()            __HAL_RCC_GPIOA_CLK_ENABLE()
#define RF_SW_CTRL2_GPIO_CLK_DISABLE()           __HAL_RCC_GPIOA_CLK_DISABLE()
</code></pre><ul>
<li>
<p>Save the file.</p>
</li>
<li>
<p>In Project Explorer expand <strong>LoRaWAN_End_Node &gt; Drivers &gt; BSP &gt; STM32WLxx_Nucleo</strong>. Double click on <code>stm32wlxx_nucleo.c</code> file and then in the Outline view double click on the <code>stm32wlxx_nucleo.h</code> file. In the <code>stm32wlxx_nucleo.h</code> file, modify the GPIO pins for the RGB LED:</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>LED</th>
<th>NUCLEO-WL55JC1</th>
<th>Generic Node Sensor Edition</th>
</tr>
</thead>
<tbody>
<tr>
<td>RED</td>
<td>PB11 (LED3)</td>
<td>PB5</td>
</tr>
<tr>
<td>GREEN</td>
<td>PB9 (LED2)</td>
<td>PB6</td>
</tr>
<tr>
<td>BLUE</td>
<td>PB15 (LED1)</td>
<td>PB7</td>
</tr>
</tbody>
</table>
<pre><code>#define LED1_PIN                                GPIO_PIN_7
#define LED1_GPIO_PORT                          GPIOB
#define LED1_GPIO_CLK_ENABLE()                  __HAL_RCC_GPIOB_CLK_ENABLE()
#define LED1_GPIO_CLK_DISABLE()                 __HAL_RCC_GPIOB_CLK_DISABLE()

#define LED2_PIN                                GPIO_PIN_6
#define LED2_GPIO_PORT                          GPIOB
#define LED2_GPIO_CLK_ENABLE()                  __HAL_RCC_GPIOB_CLK_ENABLE()
#define LED2_GPIO_CLK_DISABLE()                 __HAL_RCC_GPIOB_CLK_DISABLE()


#define LED3_PIN                                GPIO_PIN_5
#define LED3_GPIO_PORT                          GPIOB
#define LED3_GPIO_CLK_ENABLE()                  __HAL_RCC_GPIOB_CLK_ENABLE()
#define LED3_GPIO_CLK_DISABLE()                 __HAL_RCC_GPIOB_CLK_DISABLE()
</code></pre><ul>
<li>Change the button pin number from 3 to 0. This will remove the button functionality and just use a timer to send periodic messages.</li>
</ul>
<table>
<thead>
<tr>
<th>BUTTON</th>
<th>NUCLEO-WL55JC1</th>
<th>Generic Node Sensor Edition</th>
</tr>
</thead>
<tbody>
<tr>
<td>BUTTON 1</td>
<td>PA0</td>
<td>PB3</td>
</tr>
<tr>
<td>BUTTON 2</td>
<td>PA1</td>
<td>N/A</td>
</tr>
<tr>
<td>BUTTON 3</td>
<td>PC6</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<pre><code>#define BUTTONn                                 0
</code></pre><ul>
<li>
<p>Save the file.</p>
</li>
<li>
<p>In Project Explorer, expand <strong>LoRaWAN_End_Node &gt;  includes &gt; STM32Cube_FW_WL_V1.1.0\Projects\NUCLEO-WL55JC\Applications\LoRaWAN\LoRaWAN_End_Node\LoRaWAN\App</strong> and then double click on the <code>lora_app.c</code> file.</p>
</li>
</ul>
<figure>
    <img src="lora-app-c.png"
         alt="lora_app.c"/> 
</figure>

<ul>
<li>In Outline view double click on the <code>sys_conf.h</code> file.</li>
</ul>
<figure>
    <img src="sys-conf-h.png"
         alt="sys_conf.h"/> 
</figure>

<ul>
<li>In <code>sys_conf.h</code> file, make the following changes. This will make sure the debugger doesn’t crash.</li>
</ul>
<pre><code>Enable the debugger (line 61):
#define DEBUGGER_ENABLED            **1**

Disable the low power mode (line 72):
#define LOW_POWER_DISABLE           **1**
</code></pre><p>Save the file and <strong>Rebuild</strong> the project.</p>
<h2 id="debug-configurations">Debug Configurations</h2>
<ul>
<li>
<p>In Project Explorer, right-click on <strong>LoRaWAN_End_Node</strong> project, and on the menu bar, choose <strong>Debug As &gt; Debug Configurations…</strong></p>
</li>
<li>
<p>In Debug Configurations dialog box, select the <strong>New launch configurations</strong> button.</p>
</li>
</ul>
<figure>
    <img src="debug-configurations-1.png"
         alt="Debug configurations"/> 
</figure>

<ul>
<li>A new node named <strong>LoRaWAN_End_Node Debug</strong> (you can modify this name anytime) will create under the <strong>STM32 Cortex-M C/C++ Application</strong> node.</li>
</ul>
<figure>
    <img src="debug-configurations-2.png"
         alt="Debug configurations"/> 
</figure>

<ul>
<li>Select the <strong>Debugger</strong> tab and make the following settings.
<ul>
<li><strong>GDB Connection Settings</strong> - Autostart local GDB server</li>
<li><strong>Debug probe</strong> - ST-LINK (ST-LINK GDB server)</li>
<li><strong>Interface</strong> - SWD</li>
<li>Select the <strong>ST-LINK S/N</strong> checkbox and select the <strong>Scan</strong> button.</li>
<li><strong>Frequency</strong> - Auto</li>
<li><strong>Access port</strong> - 0 - Cortex-M4</li>
</ul>
</li>
</ul>
<figure>
    <img src="debug-configurations-3.png"
         alt="Debug configurations"/> 
</figure>

<h2 id="lorawan-network-commissioning-parameters">LoRaWAN Network Commissioning Parameters</h2>
<ul>
<li>In <strong>Project Explorer</strong>, expand <strong>LoRaWAN_End_Node &gt;  includes &gt; STM32Cube_FW_WL_V1.1.0\Projects\NUCLEO-WL55JC\Applications\LoRaWAN\LoRaWAN_End_Node\LoRaWAN\App</strong> and then double click on the <code>se-identity.h</code> file.</li>
</ul>
<figure>
    <img src="se-identity-h.png"
         alt="se_identity.h"/> 
</figure>

<ul>
<li>
<p>In the <code>se-identity.h</code> file,</p>
<ul>
<li>replace JoinEUI (line 103) with the AppEUI that can be found in <strong>The Things Stack: Applications &gt; your application &gt; End devices &gt; your end device &gt; Overview</strong>. For example, if you have filled it with zeros, the code should be,</li>
</ul>
<pre><code>#define LORAWAN_JOIN_EUI                                   { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }
</code></pre><ul>
<li>do not replace the <strong>DevEUI</strong> (line 98). Your DevEUI will automatically be set with a value provided by MCU.</li>
<li>replace both <strong>AppKey</strong> (line 120) and <strong>NwkKey</strong> (line 125) with the <strong>AppKey</strong> that can be found in <strong>The Things Stack: Applications &gt; your application &gt; End devices &gt; your end device &gt; Overview</strong>.</li>
</ul>
</li>
<li>
<p>Once you have edited the file, build the project again.</p>
</li>
<li>
<p>Run the application by right-clicking on the <strong>LoRaWAN_End_Node</strong> project and from the shortcut menu select <strong>Run As &gt; STM32 Cortex-M C/C++ Application</strong>.</p>
</li>
</ul>
<figure>
    <img src="run-application.png"
         alt=" Run application"/> 
</figure>

<ul>
<li>Open <strong>Tera Term</strong> or any serial terminal program. You should see an output similar to the image capture below.</li>
</ul>
<figure>
    <img src="tera-term-output.png"
         alt="Tera Term output"/> 
</figure>

<ul>
<li>In The Things Stackopen the <strong>Live data</strong> page. You will be able to see the messages coming from Generic Node Sensor Edition.</li>
</ul>
<div class="notification is-info is-light has-text-dark">
  <h5 class="title is-family-sans-serif has-text-dark mb-1">Note:</h5>
  The code is written for extracting data from the sensors (humidity, light, pressure, temperature) on NUCLEO-WL55JC1. Since we haven’t still updated the code, the payload contains bogus sensor data.
</div>
<figure>
    <img src="live-data.png"
         alt="Live data"/> 
</figure>


</div>






<div class="is-clearfix">
<a class="button is-pulled-left" href="/docs/getting-started/se-hands-on-guide/">← Sensor Edition Tutorials</a>
</div>




      </div>
    </div>
  </div>
</section>
</main>

<footer class="footer background-footer">
  <div class="container">
    <div class="columns">
      <nav class="column is-one-quarter">
        <h3 class="title is-6">The Things Stack</h3>
        <p><a class="" href="/docs/getting-started/">Getting Started</a></p>
        <p><a class="" href="/docs/applications/">Applications</a></p>
        <p><a class="" href="/docs/sensor-edition/">Sensor Edition</a></p>
        <p><a class="" href="/docs/tracker-edition/">Tracker Edition</a></p>
      </nav>
      <nav class="column is-one-quarter">
        <h3 class="title is-6">Contributing</h3>
        <p><a class="" href="https://github.com/TheThingsIndustries/generic-node-se">GitHub</a></p>
        <p><a class="" href="https://www.thethingsnetwork.org/forum/c/nodes/generic-node">Forum</a></p>
      </nav>
      
      <nav class="column is-one-quarter">
        <h3 class="title is-6">About Us</h3>
        <p><a class="" href="https://www.thethingsnetwork.org">The Things Network</a></p>
        <p><a class="" href="https://www.thethingsindustries.com">The Things Industries</a></p>
      </nav>
      </div>
  </div>
</footer>
<script src="https://www.genericnode.com/docs/js/vendor/basicLightbox.min.js"></script>
<script src="https://www.genericnode.com/docs/js/theme.min.6705961acdc7b360c900fe309485c5994ae9a75c5507bc88dbd1507420c40ae7.js" integrity="sha256-ZwWWGs3Hs2DJAP4wlIXFmUrpp1xVB7yI29FQdCDECuc=" crossorigin="anonymous"></script>

</body>

</html>
